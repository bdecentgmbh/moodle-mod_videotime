define("videotimeplugin_videojs/videotime",["exports","jquery","mod_videotime/videotime","core/log","core/notification","media_videojs/video-lazy","core/templates"],(function(_exports,_jquery,_videotime,_log,_notification,_videoLazy,_templates){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/*
   * @package    mod_videotime
   * @copyright  2021 bdecent gmbh <https://bdecent.de>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */
/*
   * Load chapters into tab
   *
   * @package    videotimetab_chapter
   * @module     videotimetab_chapter/loadchapters
   * @copyright  2022 bdecent gmbh <https://bdecent.de>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_videotime=_interopRequireDefault(_videotime),_log=_interopRequireDefault(_log),_notification=_interopRequireDefault(_notification),_videoLazy=_interopRequireDefault(_videoLazy),_templates=_interopRequireDefault(_templates);class VideoTime extends _videotime.default{initialize(){_log.default.debug("Initializing Video Time "+this.elementId),this.getInstance().then((instance=>{let options={autoplay:instance.autoplay,controls:instance.controls,responsive:instance.responsive,muted:instance.muted};!instance.responsive&&instance.height&&instance.width&&(options.height=instance.height,options.width=instance.width),_log.default.debug("Initializing VideoJS player with options:"),this.player=new _videoLazy.default(this.elementId,options);let url=new URL(window.location.href),q=url.searchParams.get("q"),starttime=(url.searchParams.get("time")||"").match(/^([0-9]+:){0,2}([0-9]+)(\.[0-9]+)$/);starttime?this.setStartTime(starttime[0]).then((function(){return q&&window.find&&window.find(q),!0})).catch(_notification.default.exception):q&&window.find&&window.find(q),this.addListeners();for(let i=0;i<this.plugins.length;i++){this.plugins[i].initialize(this,instance)}return!0})).catch(_notification.default.exeption)}addListeners(){if(this.player){if(this.player.on("play",(()=>(this.played||(this.hasPro?this.getSession().then((()=>(this.view(),this.startWatchInterval(),!0))).catch(_notification.default.exception):this.view()),!0))),this.hasPro&&(this.getResumeTime().then((seconds=>(seconds<=0||this.player.on("loaded",(()=>{let duration=this.getPlayer().duration(),resumeTime=seconds;seconds+1>=Math.floor(duration)&&(_log.default.debug("VIDEO_TIME video finished, resuming at start of video."),resumeTime=0),_log.default.debug("VIDEO_TIME resuming at "+resumeTime),this.player.setCurrentTime(resumeTime)})),!0))).catch(_notification.default.exception),this.player.on("play",function(){this.playing=!0,_log.default.debug("VIDEO_TIME play")}.bind(this)),this.player.on("playing",function(){this.playing=!0,_log.default.debug("VIDEO_TIME playing")}.bind(this)),this.player.on("pause",function(){this.playing=!1,_log.default.debug("VIDEO_TIME pause")}.bind(this)),this.player.on("stalled",function(){this.playing=!1,_log.default.debug("VIDEO_TIME stalled")}.bind(this)),this.player.on("suspend",function(){this.playing=!1,_log.default.debug("VIDEO_TIME suspend")}.bind(this)),this.player.on("abort",function(){this.playing=!1,_log.default.debug("VIDEO_TIME abort")}.bind(this)),this.player.on("playbackratechange",function(){this.playbackRate=this.player.playbackRate()}.bind(this)),this.player.on("timeupdate",function(){this.currentTime=this.player.currentTime(),this.percent=100*this.currentTime/this.player.duration(),_log.default.debug("VIDEO_TIME timeupdate. Percent: "+this.percent+". Current time: "+this.currentTime)}.bind(this)),this.player.on("ended",function(){this.playing=!1,_log.default.debug("VIDEO_TIME ended"),new Promise(function(resolve){this.getSession().then((function(session){return resolve(session),!0})).catch(_notification.default.exception)}.bind(this)).then(function(session){return this.setSessionState(session.id,1),session}.bind(this)).then(function(session){return this.setPercent(session.id,1),session}.bind(this)).then(function(session){return this.setCurrentTime(session.id,this.currentTime),session}.bind(this)).catch(_notification.default.exception).finally(function(){this.getSession().then(function(session){this.getNextActivityButtonData(session.id).then((function(response){let data=JSON.parse(response.data);if(data.instance&&parseInt(data.instance.next_activity_auto)&&!data.is_restricted&&data.hasnextcm){let link=(0,_jquery.default)('.aalink[href="'+data.nextcm_url+'"] img').first();(0,_jquery.default)(".path-course-view").length&&link?link.click():window.location.href=data.nextcm_url}return _templates.default.render("videotime/next_activity_button",JSON.parse(response.data)).then((function(html){return(0,_jquery.default)("#next-activity-button").html(html),!0})).fail(_notification.default.exception),!0})).fail(_notification.default.exception)}.bind(this)).catch(_notification.default.exception)}.bind(this)).fail(_notification.default.exception)}.bind(this)),(0,_jquery.default)((0,_jquery.default)("#"+this.elementId).closest(".videotimetabs")).each(function(i,tabs){(0,_jquery.default)(tabs).find('[data-action="cue"]').each(function(index,anchor){let starttime=anchor.getAttribute("data-start"),time=starttime.match(/((([0-9]+):)?(([0-9]+):))?([0-9]+(\.[0-9]+))/);time&&this.player.addCuePoint(3600*Number(time[3]||0)+60*Number(time[5]||0)+Number(time[6]),{starttime:starttime}).catch(_notification.default.exeception)}.bind(this)),this.player.on("cuepoint",(function(event){event.data.starttime&&((0,_jquery.default)(tabs).find(".videotime-highlight").removeClass("videotime-highlight"),(0,_jquery.default)(tabs).find('[data-action="cue"][data-start="'+event.data.starttime+'"]').closest(".row").addClass("videotime-highlight"),(0,_jquery.default)(".videotime-highlight").each((function(){this.offsetTop&&this.parentNode.scrollTo({top:this.offsetTop-50,left:0,behavior:"smooth"})})))}))}.bind(this)),this.player.options().responsive)){new ResizeObserver((()=>{this.player.height(this.player.videoHeight()/this.player.videoWidth()*this.player.currentWidth())})).observe(document.querySelector("#"+this.elementId))}}else _log.default.debug("Player was not properly initialized for course module "+this.cmId)}setStartTime(starttime){let time=starttime.match(/((([0-9]+):)?(([0-9]+):))?([0-9]+(\.[0-9]+))/);return time?(this.resumeTime=3600*Number(time[3]||0)+60*Number(time[5]||0)+Number(time[6]),this.player.currentTime(this.resumeTime)):(_log.default.debug("Set start time:"+starttime),this.player.currentTime())}}return _exports.default=VideoTime,_exports.default}));

//# sourceMappingURL=videotime.min.js.map