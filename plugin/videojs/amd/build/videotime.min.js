function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define("videotimeplugin_videojs/videotime",["exports","jquery","mod_videotime/videotime","core/log","core/notification","media_videojs/video-lazy","core/templates","media_videojs/Youtube-lazy"],(function(_exports,_jquery,_videotime,_log,_notification,_videoLazy,_templates,_YoutubeLazy){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _setPrototypeOf(o,p){return _setPrototypeOf=Object.setPrototypeOf||function(o,p){return o.__proto__=p,o},_setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var result,Super=_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&("object"===_typeof(call)||"function"==typeof call))return call;if(void 0!==call)throw new TypeError("Derived constructors may only return object or undefined");return function(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}(self)}function _getPrototypeOf(o){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o){return o.__proto__||Object.getPrototypeOf(o)},_getPrototypeOf(o)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_videotime=_interopRequireDefault(_videotime),_log=_interopRequireDefault(_log),_notification=_interopRequireDefault(_notification),_videoLazy=_interopRequireDefault(_videoLazy),_templates=_interopRequireDefault(_templates);var VideoTime=function(_VideoTimeBase){!function(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),Object.defineProperty(subClass,"prototype",{writable:!1}),superClass&&_setPrototypeOf(subClass,superClass)}(VideoTime,_VideoTimeBase);var Constructor,protoProps,staticProps,_super=_createSuper(VideoTime);function VideoTime(){return _classCallCheck(this,VideoTime),_super.apply(this,arguments)}return Constructor=VideoTime,(protoProps=[{key:"initialize",value:function(){var _this=this;_log.default.debug("Initializing Video Time "+this.elementId),this.getInstance().then((function(instance){var options={autoplay:instance.autoplay,controls:instance.controls,sources:[{type:instance.type,src:instance.vimeo_url}],loop:instance.option_loop,fluid:instance.responsive,playbackRates:instance.speed?[.5,.75,1,1.25,1.5,2]:[1],muted:instance.muted};"video/youtube"===instance.type&&(options.techOrder=["youtube"]),!instance.responsive&&instance.height&&instance.width&&(options.height=instance.height,options.width=instance.width),_log.default.debug("Initializing VideoJS player with options:"),_log.default.debug(options),_this.player=new _videoLazy.default(_this.elementId,options),_this.player.on("loadedmetadata",(function(){if(!instance.resume_playback||instance.resume_time<=0)return!0;var duration=_this.getPlayer().duration(),resumeTime=instance.resume_time;return resumeTime+1>=Math.floor(duration)&&(_log.default.debug("VIDEO_TIME video finished, resuming at start of video."),resumeTime=0),_log.default.debug("VIDEO_TIME duration is "+duration),_log.default.debug("VIDEO_TIME resuming at "+resumeTime),_this.setCurrentPosition(resumeTime),!0}));var url=new URL(window.location.href),q=url.searchParams.get("q"),starttime=(url.searchParams.get("time")||"").match(/^([0-9]+:){0,2}([0-9]+)(\.[0-9]+)$/);starttime?_this.setStartTime(starttime[0]).then((function(){return q&&window.find&&window.find(q),!0})).catch(_notification.default.exception):q&&window.find&&window.find(q),_this.addListeners();for(var i=0;i<_this.plugins.length;i++)_this.plugins[i].initialize(_this,instance);return!0})).catch(_notification.default.exeption)}},{key:"addListeners",value:function(){var _this2=this;this.player?(this.player.on("play",(function(){return _this2.played||(_this2.hasPro?_this2.getSession().then((function(){return _this2.view(),_this2.startWatchInterval(),!0})).catch(_notification.default.exception):_this2.view()),!0})),this.hasPro&&(this.player.on("play",function(){this.playing=!0,_log.default.debug("VIDEO_TIME play")}.bind(this)),this.player.on("playing",function(){this.playing=!0,_log.default.debug("VIDEO_TIME playing")}.bind(this)),this.player.on("pause",function(){this.playing=!1,_log.default.debug("VIDEO_TIME pause")}.bind(this)),this.player.on("stalled",function(){this.playing=!1,_log.default.debug("VIDEO_TIME stalled")}.bind(this)),this.player.on("suspend",function(){this.playing=!1,_log.default.debug("VIDEO_TIME suspend")}.bind(this)),this.player.on("abort",function(){this.playing=!1,_log.default.debug("VIDEO_TIME abort")}.bind(this)),this.player.on("playbackrateschange",function(){this.playbackRate=this.player.playbackRate()}.bind(this)),this.player.on("timeupdate",function(){this.currentTime=this.player.currentTime(),this.percent=this.currentTime/this.player.duration(),_log.default.debug("VIDEO_TIME timeupdate. Percent: "+this.percent+". Current time: "+this.currentTime)}.bind(this)),this.player.on("ended",function(){this.playing=!1,_log.default.debug("VIDEO_TIME ended"),new Promise(function(resolve){this.getSession().then((function(session){return resolve(session),!0})).catch(_notification.default.exception)}.bind(this)).then(function(session){return this.setSessionState(session.id,1),session}.bind(this)).then(function(session){return this.setPercent(session.id,1),session}.bind(this)).then(function(session){return this.setCurrentTime(session.id,this.currentTime),session}.bind(this)).catch(_notification.default.exception).finally(function(){this.getSession().then(function(session){this.getNextActivityButtonData(session.id).then((function(response){var data=JSON.parse(response.data);if(data.instance&&parseInt(data.instance.next_activity_auto)&&!data.is_restricted&&data.hasnextcm){var link=(0,_jquery.default)('.aalink[href="'+data.nextcm_url+'"] img').first();(0,_jquery.default)(".path-course-view").length&&link?link.click():window.location.href=data.nextcm_url}return _templates.default.render("videotime/next_activity_button",JSON.parse(response.data)).then((function(html){return(0,_jquery.default)("#next-activity-button").html(html),!0})).fail(_notification.default.exception),!0})).fail(_notification.default.exception)}.bind(this)).catch(_notification.default.exception)}.bind(this)).fail(_notification.default.exception)}.bind(this)),(0,_jquery.default)((0,_jquery.default)("#"+this.elementId).closest(".videotimetabs")).each(function(i,tabs){(0,_jquery.default)(tabs).find('[data-action="cue"]').each(function(index,anchor){var starttime=anchor.getAttribute("data-start"),time=starttime.match(/((([0-9]+):)?(([0-9]+):))?([0-9]+(\.[0-9]+))/);time&&this.player.addCuePoint(3600*Number(time[3]||0)+60*Number(time[5]||0)+Number(time[6]),{starttime:starttime}).catch(_notification.default.exeception)}.bind(this)),this.player.on("cuepoint",(function(event){event.data.starttime&&((0,_jquery.default)(tabs).find(".videotime-highlight").removeClass("videotime-highlight"),(0,_jquery.default)(tabs).find('[data-action="cue"][data-start="'+event.data.starttime+'"]').closest(".row").addClass("videotime-highlight"),(0,_jquery.default)(".videotime-highlight").each((function(){this.offsetTop&&this.parentNode.scrollTo({top:this.offsetTop-50,left:0,behavior:"smooth"})})))}))}.bind(this)),this.player.options().responsive&&new ResizeObserver((function(){_this2.player.height(_this2.player.videoHeight()/_this2.player.videoWidth()*_this2.player.currentWidth())})).observe(document.querySelector("#"+this.elementId)))):_log.default.debug("Player was not properly initialized for course module "+this.cmId)}},{key:"setStartTime",value:function(starttime){var time=starttime.match(/((([0-9]+):)?(([0-9]+):))?([0-9]+(\.[0-9]+))/);return time?(this.resumeTime=3600*Number(time[3]||0)+60*Number(time[5]||0)+Number(time[6]),this.player.currentTime(this.resumeTime)):(_log.default.debug("Set start time:"+starttime),this.player.currentTime())}},{key:"getDuration",value:function(){var _this3=this;return new Promise((function(resolve){return resolve(_this3.player.duration()),!0}))}},{key:"getPlaybackRate",value:function(){var _this4=this;return new Promise((function(resolve){return resolve(_this4.player.playbackRate()),!0}))}},{key:"setCurrentPosition",value:function(secs){var _this5=this;return new Promise((function(resolve){return resolve(_this5.player.currentTime(secs)),!0}))}},{key:"getCurrentPosition",value:function(){var _this6=this;return new Promise((function(resolve){return resolve(_this6.player.currentTime()),!0}))}}])&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),VideoTime}(_videotime.default);return _exports.default=VideoTime,_exports.default}));

//# sourceMappingURL=videotime.min.js.map