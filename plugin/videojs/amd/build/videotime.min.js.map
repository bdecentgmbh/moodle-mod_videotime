{"version":3,"file":"videotime.min.js","sources":["../src/videotime.js"],"sourcesContent":["/*\n * Video time player specific js\n *\n * @package    videotimeplugin_videojs\n * @module     videotimeplugin_videojs/videotime\n * @copyright  2022 bdecent gmbh <https://bdecent.de>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from \"jquery\";\nimport VideoTimeBase from \"mod_videotime/videotime\";\nimport Log from \"core/log\";\nimport Notification from \"core/notification\";\nimport Player from \"media_videojs/video-lazy\";\nimport \"media_videojs/Youtube-lazy\";\n\nexport default class VideoTime extends VideoTimeBase {\n    initialize() {\n        Log.debug(\"Initializing Video Time \" + this.elementId);\n\n        let instance = this.instance,\n            options = {\n                autoplay: Number(instance.autoplay),\n                controls: Number(instance.controls),\n                sources: [{ type: instance.type, src: instance.vimeo_url }],\n                loop: Number(instance.option_loop),\n                fluid: Number(instance.responsive),\n                playbackRates: instance.speed\n                    ? [0.5, 0.75, 1, 1.25, 1.5, 2]\n                    : [1],\n                muted: Number(instance.muted)\n            };\n        if (instance.type === \"video/youtube\") {\n            options.techOrder = [\"youtube\"];\n        }\n        if (!instance.responsive && instance.height && instance.width) {\n            options.height = instance.height;\n            options.width = instance.width;\n        }\n        Log.debug(\"Initializing VideoJS player with options:\");\n        Log.debug(options);\n        this.player = new Player(this.elementId, options);\n\n        this.player.on(\"loadedmetadata\", () => {\n            if (!instance.resume_playback || instance.resume_time <= 0 || this.resumed) {\n                return true;\n            }\n\n            let duration = this.getPlayer().duration(),\n                resumeTime = instance.resume_time;\n            // Duration is often a little greater than a resume time at the end of the video.\n            // A user may have watched 100 seconds when the video ends, but the duration may be\n            // 100.56 seconds. BUT, sometimes the duration is rounded depending on when the\n            // video loads, so it may be 101 seconds. Hence the +1 and Math.floor usage.\n            if (resumeTime + 1 >= Math.floor(duration)) {\n                Log.debug(\n                    \"VIDEO_TIME video finished, resuming at start of video.\"\n                );\n                resumeTime = 0;\n            }\n            Log.debug(\"VIDEO_TIME duration is \" + duration);\n            Log.debug(\"VIDEO_TIME resuming at \" + resumeTime);\n            if (resumeTime) {\n                setTimeout(() => {\n                this.setCurrentPosition(resumeTime);\n                }, 10);\n            }\n            return true;\n        });\n\n        let url = new URL(window.location.href),\n            q = url.searchParams.get(\"q\"),\n            starttime = (url.searchParams.get(\"time\") || \"\").match(\n                /^([0-9]+:){0,2}([0-9]+)(\\.[0-9]+)$/\n            );\n        if (starttime) {\n            this.setStartTime(starttime[0])\n                .then(function() {\n                    if (q && window.find) {\n                        window.find(q);\n                    }\n                    return true;\n                })\n                .catch(Notification.exception);\n        } else if (q && window.find) {\n            window.find(q);\n        }\n\n        this.addListeners();\n\n        for (let i = 0; i < this.plugins.length; i++) {\n            const plugin = this.plugins[i];\n            plugin.initialize(this, instance);\n        }\n\n        return true;\n    }\n\n    /**\n     * Register player events to respond to user interaction and play progress.\n     */\n    addListeners() {\n        // If this is a tab play set time cues and listener.\n        $($(\"#\" + this.elementId).closest(\".videotimetabs\")).each(\n            function(i, tabs) {\n                $(tabs)\n                    .find('[data-action=\"cue\"]')\n                    .each(\n                        function(index, anchor) {\n                            let starttime = anchor.getAttribute(\"data-start\"),\n                                time = starttime.match(\n                                    /((([0-9]+):)?(([0-9]+):))?([0-9]+(\\.[0-9]+))/\n                                );\n                            if (time) {\n                                this.player\n                                    .addCuePoint(\n                                        3600 * Number(time[3] || 0) +\n                                            60 * Number(time[5] || 0) +\n                                            Number(time[6]),\n                                        {\n                                            starttime: starttime\n                                        }\n                                    )\n                                    .catch(Notification.exeception);\n                            }\n                        }.bind(this)\n                    );\n\n                this.player.on(\"cuepoint\", function(event) {\n                    if (event.data.starttime) {\n                        $(tabs)\n                            .find(\".videotime-highlight\")\n                            .removeClass(\"videotime-highlight\");\n                        $(tabs)\n                            .find(\n                                '[data-action=\"cue\"][data-start=\"' +\n                                    event.data.starttime +\n                                    '\"]'\n                            )\n                            .closest(\".row\")\n                            .addClass(\"videotime-highlight\");\n                        $(\".videotime-highlight\").each(function() {\n                            if (this.offsetTop) {\n                                this.parentNode.scrollTo({\n                                    top: this.offsetTop - 50,\n                                    left: 0,\n                                    behavior: \"smooth\"\n                                });\n                            }\n                        });\n                    }\n                });\n            }.bind(this)\n        );\n\n        if (!this.player) {\n            Log.debug(\n                \"Player was not properly initialized for course module \" +\n                    this.cmId\n            );\n            return;\n        }\n\n        // Fire view event in Moodle on first play only.\n        this.player.on(\"play\", () => {\n            if (!this.played) {\n                if (this.hasPro) {\n                    // Getting a new session on first play.\n                    this.getSession()\n                        .then(() => {\n                            this.view();\n                            this.startWatchInterval();\n                            return true;\n                        })\n                        .catch(Notification.exception);\n                } else {\n                    // Free version can still mark completion on video time view.\n                    this.view();\n                }\n            }\n            return true;\n        });\n\n        // Features beyond this point are for pro only.\n        if (!this.hasPro) {\n            return;\n        }\n\n        // Note: Vimeo player does not support multiple events in a single on() call. Each requires it's own function.\n\n        // Catch all events where video plays.\n        this.player.on(\n            \"play\",\n            function() {\n                this.playing = true;\n                Log.debug(\"VIDEO_TIME play\");\n            }.bind(this)\n        );\n        this.player.on(\n            \"playing\",\n            function() {\n                this.playing = true;\n                Log.debug(\"VIDEO_TIME playing\");\n            }.bind(this)\n        );\n\n        // Catch all events where video stops.\n        this.player.on(\n            \"pause\",\n            function() {\n                this.playing = false;\n                Log.debug(\"VIDEO_TIME pause\");\n            }.bind(this)\n        );\n        this.player.on(\n            \"stalled\",\n            function() {\n                this.playing = false;\n                Log.debug(\"VIDEO_TIME stalled\");\n            }.bind(this)\n        );\n        this.player.on(\n            \"suspend\",\n            function() {\n                this.playing = false;\n                Log.debug(\"VIDEO_TIME suspend\");\n            }.bind(this)\n        );\n        this.player.on(\n            \"abort\",\n            function() {\n                this.playing = false;\n                Log.debug(\"VIDEO_TIME abort\");\n            }.bind(this)\n        );\n\n        this.player.on(\n            \"playbackrateschange\",\n            function() {\n                this.playbackRate = this.player.playbackRate();\n            }.bind(this)\n        );\n\n        // Always update internal values for percent and current time watched.\n        this.player.on(\n            \"timeupdate\",\n            function() {\n                this.currentTime = this.player.currentTime();\n                this.percent = this.currentTime / this.player.duration();\n                Log.debug(\n                    \"VIDEO_TIME timeupdate. Percent: \" +\n                        this.percent +\n                        \". Current time: \" +\n                        this.currentTime\n                );\n            }.bind(this)\n        );\n\n        // Initiate video finish procedure.\n        this.player.on(\"ended\", this.handleEnd.bind(this));\n\n        // Readjust height when responsive player is resized.\n        if (this.player.options().responsive) {\n            let observer = new ResizeObserver(() => {\n                this.player.height(\n                    (this.player.videoHeight() / this.player.videoWidth()) *\n                        this.player.currentWidth()\n                );\n            });\n            observer.observe(document.querySelector(\"#\" + this.elementId));\n        }\n    }\n\n    /**\n     * Parse start time and set player\n     *\n     * @param {string} starttime\n     * @returns {Promise}\n     */\n    setStartTime(starttime) {\n        let time = starttime.match(\n            /((([0-9]+):)?(([0-9]+):))?([0-9]+(\\.[0-9]+))/\n        );\n        if (time) {\n            this.resumeTime =\n                3600 * Number(time[3] || 0) +\n                60 * Number(time[5] || 0) +\n                Number(time[6]);\n            return this.player.currentTime(this.resumeTime);\n        }\n        Log.debug(\"Set start time:\" + starttime);\n        return this.player.currentTime();\n    }\n\n    /**\n     * Get play back rate\n     *\n     * @returns {Promise}\n     */\n    getDuration() {\n        return new Promise(resolve => {\n            resolve(this.player.duration());\n            return true;\n        });\n    }\n\n    /**\n     * Get duration of video\n     *\n     * @returns {Promise}\n     */\n    getPlaybackRate() {\n        return new Promise(resolve => {\n            resolve(this.player.playbackRate());\n            return true;\n        });\n    }\n\n    /**\n     * Set current time of player\n     *\n     * @param {float} secs time\n     * @returns {Promise}\n     */\n    setCurrentPosition(secs) {\n        return new Promise(resolve => {\n            resolve(this.player.currentTime(secs));\n            return true;\n        });\n    }\n\n    /**\n     * Get current time of player\n     *\n     * @returns {Promise}\n     */\n    getCurrentPosition() {\n        return new Promise(resolve => {\n            resolve(this.player.currentTime());\n            return true;\n        });\n    }\n}\n"],"names":["VideoTime","VideoTimeBase","initialize","debug","this","elementId","instance","options","autoplay","Number","controls","sources","type","src","vimeo_url","loop","option_loop","fluid","responsive","playbackRates","speed","muted","techOrder","height","width","player","Player","on","resume_playback","resume_time","resumed","duration","getPlayer","resumeTime","Math","floor","setTimeout","setCurrentPosition","url","URL","window","location","href","q","searchParams","get","starttime","match","setStartTime","then","find","catch","Notification","exception","addListeners","i","plugins","length","closest","each","tabs","index","anchor","getAttribute","time","addCuePoint","exeception","bind","event","data","removeClass","addClass","offsetTop","parentNode","scrollTo","top","left","behavior","played","hasPro","getSession","view","startWatchInterval","playing","playbackRate","currentTime","percent","handleEnd","ResizeObserver","videoHeight","videoWidth","currentWidth","observe","document","querySelector","cmId","getDuration","Promise","resolve","getPlaybackRate","secs","getCurrentPosition"],"mappings":"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"}