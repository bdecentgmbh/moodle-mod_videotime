function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define("videotimeplugin_live/videotime",["exports","core/ajax","mod_videotime/videotime","block_deft/janus-gateway","core/log","core/notification","block_deft/publish","block_deft/subscribe","videotimeplugin_live/socket"],(function(_exports,_ajax,_videotime,_janusGateway,_log,_notification,_publish,_subscribe,_socket){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),Object.defineProperty(subClass,"prototype",{writable:!1}),superClass&&_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){return _setPrototypeOf=Object.setPrototypeOf||function(o,p){return o.__proto__=p,o},_setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var result,Super=_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&("object"===_typeof(call)||"function"==typeof call))return call;if(void 0!==call)throw new TypeError("Derived constructors may only return object or undefined");return function(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}(self)}function _getPrototypeOf(o){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o){return o.__proto__||Object.getPrototypeOf(o)},_getPrototypeOf(o)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_ajax=_interopRequireDefault(_ajax),_videotime=_interopRequireDefault(_videotime),_janusGateway=_interopRequireDefault(_janusGateway),_log=_interopRequireDefault(_log),_notification=_interopRequireDefault(_notification),_publish=_interopRequireDefault(_publish),_subscribe=_interopRequireDefault(_subscribe),_socket=_interopRequireDefault(_socket);var rooms={},Publish=function(_PublishBase){_inherits(Publish,_PublishBase);var _super=_createSuper(Publish);function Publish(){return _classCallCheck(this,Publish),_super.apply(this,arguments)}return _createClass(Publish,[{key:"register",value:function(pluginHandle){return _ajax.default.call([{args:{handle:pluginHandle.getId(),id:Number(this.peerid),plugin:pluginHandle.plugin,room:this.roomid,ptype:"publish"==this.ptype,session:pluginHandle.session.getSessionId()},contextid:this.contextid,fail:_notification.default.exception,methodname:"videotimeplugin_live_join_room"}])[0]}},{key:"publishFeed",value:function(){var _this=this;this.videoroom.webrtcStuff.pc&&"connected"==this.videoroom.webrtcStuff.pc.iceConnectionState&&setTimeout((function(){return _this.videoroom.webrtcStuff.pc.getTransceivers().forEach((function(transceiver){var sender=transceiver.sender;if(sender.track&&_this.selectedTrack&&sender.track.id==_this.selectedTrack.id){var message=JSON.stringify({feed:Number(_this.peerid),mid:transceiver.mid});_this.videoroom.data({text:message,error:_log.default.debug})}})),_ajax.default.call([{args:{id:Number(_this.peerid),room:_this.roomid},contextid:_this.contextid,fail:_notification.default.exception,methodname:"videotimeplugin_live_publish_feed"}])[0]}))}},{key:"unpublish",value:function(){var _this2=this;this.videoInput&&(this.videoInput.then((function(videoStream){return videoStream&&videoStream.getVideoTracks().forEach((function(track){track.stop()})),_this2.videoInput=null,videoStream})).catch(_notification.default.exception),this.videoroom.send({message:{request:"unpublish"}})),document.querySelectorAll('[data-contextid="'+this.contextid+'"][data-action="publish"]').forEach((function(button){button.classList.remove("hidden")}))}},{key:"onLocalTrack",value:function(track,on){var remoteStream=new MediaStream([track]);remoteStream.mid=track.mid,_log.default.debug(on),_log.default.debug(remoteStream),_janusGateway.default.attachMediaStream(document.getElementById("video-controls-"+this.tracks[track.id]),remoteStream)}},{key:"handleClick",value:function(e){var _this3=this,button=e.target.closest('[data-contextid="'+this.contextid+'"][data-action="publish"],  [data-contextid="'+this.contextid+'"][data-action="unpublish"]');if(button){var action=button.getAttribute("data-action"),type=button.getAttribute("data-type")||"camera";switch(e.stopPropagation(),e.preventDefault(),document.querySelectorAll('[data-region="deft-venue"] [data-action="publish"],  [data-region="deft-venue"] [data-action="unpublish"]').forEach((function(button){button.getAttribute("data-action")==action&&button.getAttribute("data-type")==type||button.classList.remove("hidden")})),action){case"publish":_log.default.debug(type),"display"==type?this.shareDisplay():this.shareCamera(),this.videoInput.then((function(videoStream){var tracks=[];return videoStream&&(videoStream.getVideoTracks().forEach((function(track){tracks.push({type:"video",capture:track,recv:!1}),_this3.selectedTrack=track,_this3.tracks=_this3.tracks||{},_this3.tracks[track.id]=type})),videoStream.getAudioTracks().forEach((function(track){tracks.push({type:"audio",capture:track,recv:!1})})),_this3.videoroom.createOffer({tracks:tracks,success:function(jsep){_this3.videoroom.send({message:{request:"configure",video:!0,audio:!0},jsep:jsep})},error:function(_error){_notification.default.alert("WebRTC error... ",_error.message)}})),videoStream})).catch(_notification.default.exception);break;case"unpublish":return this.videoInput&&this.videoInput.then((function(videoStream){return videoStream&&videoStream.getVideoTracks().forEach((function(track){track.stop()})),_this3.videoInput=null,videoStream})).catch(_notification.default.exception),this.videoroom.send({message:{request:"unpublish"}}),_ajax.default.call([{args:{id:Number(this.peerid),publish:!1,room:this.roomid},contextid:this.contextid,fail:_notification.default.exception,methodname:"videotimeplugin_publish_feed"}])[0]}}return!0}}]),Publish}(_publish.default),VideoTime=function(_VideoTimeBase){_inherits(VideoTime,_VideoTimeBase);var _super2=_createSuper(VideoTime);function VideoTime(){return _classCallCheck(this,VideoTime),_super2.apply(this,arguments)}return _createClass(VideoTime,[{key:"initialize",value:function(contextid,token,peerid){var _this4=this;return _log.default.debug("Initializing Video Time "+this.elementId),this.contextid=contextid,this.peerid=peerid,_ajax.default.call([{methodname:"videotimeplugin_live_get_room",args:{contextid:contextid},done:function(response){var socket=new _socket.default(contextid,token);_this4.iceservers=JSON.parse(response.iceservers),_this4.roomid=response.roomid,_this4.server=response.server,rooms[String(contextid)]={contextid:contextid,peerid:peerid,roomid:response.roomid,server:response.server,iceServers:JSON.parse(response.iceservers)},_this4.roomid=response.roomid,socket.subscribe((function(){_ajax.default.call([{methodname:"videotimeplugin_live_get_feed",args:{contextid:contextid},done:function(response){var room=rooms[String(contextid)];room.publish&&room.publish.restart&&(response.feed==peerid&&_this4.unpublish(),room.publish=null),_this4.subscribeTo(Number(response.feed))},fail:_notification.default.exception}])}))},fail:_notification.default.exception}]),this.addListeners(),!0}},{key:"addListeners",value:function(){document.querySelector("body").removeEventListener("click",handleClick),document.querySelector("body").addEventListener("click",handleClick)}},{key:"subscribeTo",value:function(source){var _this5=this;if(document.querySelectorAll('[data-contextid="'+this.contextid+'"][data-action="publish"]').forEach((function(button){Number(_this5.peerid),button.classList.remove("hidden")})),document.querySelectorAll('[data-contextid="'+this.contextid+'"][data-action="unpublish"]').forEach((function(button){Number(_this5.peerid),button.classList.remove("hidden")})),_log.default.debug(source),_log.default.debug(this.peerid),!this.remoteFeed||this.remoteFeed.creatingSubscription||this.remoteFeed.restart)this.remoteFeed&&this.remoteFeed.restart?this.remoteFeed.current!=source&&(this.remoteFeed=null,this.subscribeTo(source)):this.remoteFeed?setTimeout((function(){_this5.subscribeTo(source)}),500):source&&(this.remoteFeed=new Subscribe(this.contextid,this.iceservers,this.roomid,this.server,this.peerid,source),this.remoteFeed.remoteVideo=document.getElementById(this.elementId),this.remoteFeed.remoteAudio=document.getElementById(this.elementId).parentNode.querySelector("audio"),this.remoteFeed.startConnection(source),document.querySelectorAll('[data-contextid="'+this.contextid+'"] img.poster-img').forEach((function(img){img.classList.add("hidden")})),document.querySelectorAll('[data-contextid="'+this.contextid+'"] video').forEach((function(img){img.classList.remove("hidden")})));else{var update={request:"update",subscribe:[{feed:Number(source)}],unsubscribe:[{feed:Number(this.remoteFeed.current)}]};if(!source&&this.remoteFeed.current?delete update.subscribe:source&&!this.remoteFeed.current&&delete update.unsubscribe,this.remoteFeed.current!=source){if(this.remoteFeed.videoroom.send({message:update}),this.remoteFeed.current==this.peerid)rooms[String(this.contextid)].publish.unpublish();this.remoteFeed.current=source,_log.default.debug('[data-contextid="'+this.contextid+'"] img.poster-img'),source?(document.querySelectorAll('[data-contextid="'+this.contextid+'"] img.poster-img').forEach((function(img){img.classList.add("hidden")})),document.querySelectorAll('[data-contextid="'+this.contextid+'"] video').forEach((function(img){img.classList.remove("hidden")}))):(document.querySelectorAll('[data-contextid="'+this.contextid+'"] img.poster-img').forEach((function(img){img.classList.remove("hidden")})),document.querySelectorAll('[data-contextid="'+this.contextid+'"] video').forEach((function(img){img.classList.add("hidden")})))}}}}]),VideoTime}(_videotime.default);_exports.default=VideoTime;var handleClick=function(e){var button=e.target.closest('[data-roomid] [data-action="publish"], [data-roomid] [data-action="unpublish"]');if(button){var action=button.getAttribute("data-action"),contextid=e.target.closest("[data-contextid]").getAttribute("data-contextid"),room=rooms[String(contextid)],iceServers=room.iceServers,peerid=room.peerid,roomid=room.roomid,server=room.server,type=button.getAttribute("data-type");e.stopPropagation(),e.preventDefault(),"unpublish"==action?_ajax.default.call([{args:{id:Number(peerid),room:roomid,publish:!1},contextid:contextid,fail:_notification.default.exception,methodname:"videotimeplugin_live_publish_feed"}]):!room.publish||room.publish.restart?(room.publish=new Publish(contextid,iceServers,roomid,server,peerid),"display"==type?room.publish.shareDisplay():room.publish.shareCamera(),room.publish.startConnection()):room.publish.handleClick(e)}},Subscribe=function(_SubscribeBase){_inherits(Subscribe,_SubscribeBase);var _super3=_createSuper(Subscribe);function Subscribe(){return _classCallCheck(this,Subscribe),_super3.apply(this,arguments)}return _createClass(Subscribe,[{key:"register",value:function(pluginHandle){return _ajax.default.call([{args:{handle:pluginHandle.getId(),id:Number(this.peerid),plugin:pluginHandle.plugin,room:this.roomid,ptype:!1,feed:this.feed,session:pluginHandle.session.getSessionId()},contextid:this.contextid,fail:_notification.default.exception,methodname:"videotimeplugin_live_join_room"}])[0]}}]),Subscribe}(_subscribe.default);return _exports.default}));

//# sourceMappingURL=videotime.min.js.map