{"version":3,"sources":["../src/videotime.js"],"names":["define","$","Vimeo","Ajax","Log","Templates","Notification","VideoTime","elementId","cmId","hasPro","interval","player","resumeTime","session","instance","played","playing","time","percent","currentTime","playbackRate","plugins","prototype","getCmId","registerPlugin","plugin","push","initialize","debug","Promise","resolve","getInstance","then","addListeners","i","length","getPlayer","this","on","getSession","view","getResumeTime","seconds","setCurrentTime","bind","getPlaybackRate","event","setSessionState","id","setPercent","catch","error","alert","finally","getNextActivityButtonData","response","data","JSON","parse","parseInt","next_activity_auto","is_restricted","hasnextcm","window","location","href","nextcm_url","render","html","startWatchInterval","setInterval","recordWatchTime","sessionId","state","call","methodname","args","session_id","current_time","cmid","fail","exception"],"mappings":"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","sourcesContent":["/*\n * @package    mod_videotime\n * @copyright  2018 bdecent gmbh <https://bdecent.de>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @module mod_videotime/videotime\n */\ndefine(['jquery', 'mod_videotime/player', 'core/ajax', 'core/log', 'core/templates', 'core/notification'], function($, Vimeo, Ajax, Log, Templates, Notification) {\n\n    let VideoTime = function(elementId, cmId, hasPro, interval) {\n        this.elementId = elementId;\n        this.cmId = cmId;\n        this.hasPro = hasPro;\n        this.interval = interval;\n        this.player = null;\n        this.resumeTime = null;\n        this.session = null;\n        this.instance = null;\n\n        this.played = false;\n\n        this.playing = false;\n        this.time = 0;\n        this.percent = 0;\n        this.currentTime = 0;\n        this.playbackRate = 1;\n\n        this.plugins = [];\n    };\n\n    /**\n     * Get course module ID of this VideoTime instance.\n     *\n     * @return {int}\n     */\n    VideoTime.prototype.getCmId = function() {\n        return this.cmId;\n    };\n\n    VideoTime.prototype.registerPlugin = function(plugin) {\n        this.plugins.push(plugin);\n    };\n\n    VideoTime.prototype.initialize = function() {\n        Log.debug('Initializing Video Time ' + this.elementId);\n\n        if (this.resumeTime) {\n            return Promise.resolve(this.resumeTime);\n        }\n\n        this.getInstance().then((instance) => {\n            Log.debug('Initializing Vimeo player with options:');\n            Log.debug(instance);\n            this.player = new Vimeo(this.elementId, instance);\n            this.addListeners();\n\n            for (let i = 0; i < this.plugins.length; i++) {\n                const plugin = this.plugins[i];\n                plugin.initialize(this, instance);\n            }\n\n            return true;\n        });\n    };\n\n    /**\n     * Get Vimeo player object.\n     *\n     * @returns {Vimeo}\n     */\n    VideoTime.prototype.getPlayer = function() {\n        return this.player;\n    };\n\n    /**\n     * Register player events to respond to user interaction and play progress.\n     */\n    VideoTime.prototype.addListeners = function() {\n        if (!this.player) {\n            Log.debug('Player was not properly initialized for course module ' . this.cmId);\n        }\n\n        // Fire view event in Moodle on first play only.\n        this.player.on('play', () => {\n            if (!this.played) {\n                if (this.hasPro) {\n                    // Getting a new session on first play.\n                    this.getSession().then(() => {\n                        this.view();\n                    });\n                } else {\n                    // Free version can still mark completion on video time view.\n                    this.view();\n                }\n            }\n        });\n\n        // Features beyond this point are for pro only.\n        if (!this.hasPro) {\n            return;\n        }\n\n        // If resume is present force seek the player to that point.\n        this.getResumeTime().then((seconds) => {\n            Log.debug('VIDEO_TIME resuming at ' + seconds);\n            if (seconds && seconds > 0) {\n                this.player.on('loaded', () => {\n                    this.player.setCurrentTime(seconds);\n                });\n            }\n        });\n\n        // Note: Vimeo player does not support multiple events in a single on() call. Each requires it's own function.\n\n        // Catch all events where video plays.\n        this.player.on('play', function (e) {\n            this.playing = true;\n            Log.debug('VIDEO_TIME play');\n        }.bind(this));\n        this.player.on('playing', function () {\n            this.playing = true;\n            Log.debug('VIDEO_TIME playing');\n        }.bind(this));\n\n        // Catch all events where video stops.\n        this.player.on('pause', function () {\n            this.playing = false;\n            Log.debug('VIDEO_TIME pause');\n        }.bind(this));\n        this.player.on('stalled', function () {\n            this.playing = false;\n            Log.debug('VIDEO_TIME stalled');\n        }.bind(this));\n        this.player.on('suspend', function () {\n            this.playing = false;\n            Log.debug('VIDEO_TIME suspend');\n        }.bind(this));\n        this.player.on('abort', function () {\n            this.playing = false;\n            Log.debug('VIDEO_TIME abort');\n        }.bind(this));\n\n        this.player.getPlaybackRate().then(function(playbackRate) {\n            this.playbackRate = playbackRate;\n        }.bind(this));\n\n        this.player.on('playbackratechange', function(event) {\n            this.playbackRate = event.playbackRate;\n        }.bind(this));\n\n        // Always update internal values for percent and current time watched.\n        this.player.on('timeupdate', function(event) {\n            this.percent = event.percent;\n            this.currentTime = event.seconds;\n            Log.debug('VIDEO_TIME timeupdate. Percent: ' + this.percent + '. Current time: ' + this.currentTime);\n        }.bind(this));\n\n        // Initiate video finish procedure.\n        this.player.on('ended', function () {\n            this.playing = false;\n            Log.debug('VIDEO_TIME ended');\n\n            new Promise(function(resolve, reject) {\n                this.getSession().then(function(session) {\n                    resolve(session);\n                });\n            }.bind(this)).then(function(session) {\n                this.setSessionState(session.id, 1);\n                return session;\n            }.bind(this)).then(function(session) {\n                this.setPercent(session.id, 1);\n                return session;\n            }.bind(this)).then(function(session) {\n                this.setCurrentTime(session.id, this.currentTime);\n                return session;\n            }.bind(this)).catch(function(error) {\n                alert(error);\n            }).finally(function(session) {\n                this.getSession().then(function(session) {\n                    this.getNextActivityButtonData(session.id).then(function(response) {\n                        let data = JSON.parse(response.data);\n\n                        if (parseInt(data.instance.next_activity_auto)) {\n                            if (!data.is_restricted && data.hasnextcm) {\n                                window.location.href = data.nextcm_url;\n                            }\n                        }\n\n                        Templates.render('videotime/next_activity_button', JSON.parse(response.data))\n                            .then(function (html, js) {\n                                $('#next-activity-button').html(html);\n                            });\n                    }.bind(this));\n                }.bind(this));\n            }.bind(this));\n        }.bind(this));\n\n        this.startWatchInterval();\n    };\n\n    /**\n     * Start interval that will periodically record user progress via Ajax.\n     */\n    VideoTime.prototype.startWatchInterval = function() {\n        setInterval(function () {\n            if (this.playing) {\n                this.time += this.playbackRate;\n\n                this.getSession().then(function(session) {\n                    if (this.time % this.interval === 0) {\n                        Log.debug('VIDEO_TIME watch_time: ' + this.time + '. percent: ' + this.percent);\n                        this.recordWatchTime(session.id, this.time);\n                        this.setPercent(session.id, this.percent);\n                        this.setCurrentTime(session.id, this.currentTime);\n                    }\n                }.bind(this));\n            }\n        }.bind(this), 1000);\n    };\n\n    /**\n     * Set state on session.\n     *\n     * @param sessionId\n     * @param state\n     * @returns {Promise}\n     */\n    VideoTime.prototype.setSessionState = function(sessionId, state) {\n        return Ajax.call([{\n            methodname: 'videotimeplugin_pro_set_session_state',\n            args: {session_id: sessionId, state: state}\n        }])[0];\n    };\n\n    /**\n     * Set current watch time for video. Used for resuming.\n     *\n     * @param {int} sessionId\n     * @param {float} currentTime\n     * @returns {Promise}\n     */\n    VideoTime.prototype.setCurrentTime = function(sessionId, currentTime) {\n        return Ajax.call([{\n            methodname: 'videotimeplugin_pro_set_session_current_time',\n            args: {session_id: sessionId, current_time: currentTime}\n        }])[0];\n    };\n\n    /**\n     * Set video watch percentage for session.\n     *\n     * @param {int} sessionId\n     * @param {float} percent\n     * @returns {Promise}\n     */\n    VideoTime.prototype.setPercent = function(sessionId, percent) {\n        return Ajax.call([{\n            methodname: 'videotimeplugin_pro_set_percent',\n            args: {session_id: sessionId, percent: percent}\n        }])[0];\n    };\n\n    /**\n     * Record watch time for session.\n     *\n     * @param {int} sessionId\n     * @param {float} time\n     * @returns {Promise}\n     */\n    VideoTime.prototype.recordWatchTime = function(sessionId, time) {\n        return Ajax.call([{\n            methodname: 'videotimeplugin_pro_record_watch_time',\n            args: {session_id: sessionId, time: time}\n        }])[0];\n    };\n\n    /**\n     * Get data for next activity button.\n     *\n     * @param {int} sessionId\n     * @returns {Promise}\n     */\n    VideoTime.prototype.getNextActivityButtonData = function(sessionId) {\n        return Ajax.call([{\n            methodname: 'videotimeplugin_pro_get_next_activity_button_data',\n            args: { session_id: sessionId }\n        }])[0];\n    };\n\n    /**\n     * Get VideoTime instance for this course module.\n     *\n     * @returns {Promise}\n     */\n    VideoTime.prototype.getInstance = function() {\n        if (this.instance) {\n            return Promise.resolve(this.instance);\n        }\n\n        return new Promise((resolve) => {\n            Ajax.call([{\n                methodname: 'mod_videotime_get_videotime',\n                args: {cmid: this.cmId}\n            }])[0].then((response) => {\n                this.instance = response;\n                resolve(this.instance);\n            }).fail(Notification.exception);\n        });\n    };\n\n    /**\n     * Get time to resume video as seconds.\n     *\n     * @returns {Promise}\n     */\n    VideoTime.prototype.getResumeTime = function() {\n        if (this.resumeTime) {\n            return Promise.resolve(this.resumeTime);\n        }\n\n        return new Promise((resolve) => {\n            Ajax.call([{\n                methodname: 'videotimeplugin_pro_get_resume_time',\n                args: {cmid: this.cmId}\n            }])[0].then((response) => {\n                this.resumeTime = response.seconds;\n                resolve(this.resumeTime);\n                return true;\n            }).fail(Notification.exception);\n        });\n    };\n\n    /**\n     * Get new or existing video viewing session.\n     *\n     * @returns {Promise}\n     */\n    VideoTime.prototype.getSession = function() {\n        if (this.session) {\n            return Promise.resolve(this.session);\n        }\n\n        return new Promise((resolve, reject) => {\n            Ajax.call([{\n                methodname: 'videotimeplugin_pro_get_new_session',\n                args: { cmid: this.cmId }\n            }])[0].then(function(response) {\n                this.session = response;\n                resolve(response);\n            }.bind(this));\n        });\n    };\n\n    /**\n     * Log the user view of video.\n     *\n     * @returns {Promise}\n     */\n    VideoTime.prototype.view = function() {\n        return Ajax.call([{\n            methodname: 'mod_videotime_view_videotime',\n            args: { cmid: this.cmId }\n        }])[0];\n    };\n\n    return VideoTime;\n});\n"],"file":"videotime.min.js"}