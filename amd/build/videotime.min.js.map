{"version":3,"sources":["../src/videotime.js"],"names":["define","$","Vimeo","Ajax","log","Templates","init","session","interval","hasPro","embedOptions","cmid","resumeTime","nextActivityUrl","debug","length","player","playing","time","percent","currentTime","on","setCurrentTime","call","methodname","args","session_id","id","state","done","current_time","window","location","href","response","render","JSON","parse","data","then","html","event","seconds","setInterval"],"mappings":"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","sourcesContent":["/*\r\n * @package    mod_videotime\r\n * @copyright  2018 bdecent gmbh <https://bdecent.de>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\n/**\r\n * @module block_overview/helloworld\r\n */\r\ndefine(['jquery', 'mod_videotime/player', 'core/ajax', 'core/log', 'core/templates'], function($, Vimeo, Ajax, log, Templates) {\r\n    return {\r\n        init: function(session, interval, hasPro, embedOptions, cmid, resumeTime, nextActivityUrl) {\r\n\r\n            log.debug('VIDEO_TIME embed options', embedOptions);\r\n\r\n            // Check if Vimeo video element exists.\r\n            if ($('#vimeo-embed-' + cmid).length == 0) {\r\n                log.debug(\"Vimeo video element not found: #vimeo-embed-\" + cmid);\r\n                return;\r\n            }\r\n\r\n            var player = new Vimeo('vimeo-embed-' + cmid, embedOptions);\r\n\r\n            if (hasPro) {\r\n                var playing = false;\r\n                var time = 0;\r\n                var percent = 0;\r\n                var currentTime = 0;\r\n\r\n                if (resumeTime > 0) {\r\n                    player.on('loaded', function() {\r\n                        player.setCurrentTime(resumeTime);\r\n                    });\r\n                }\r\n\r\n                player.on('play', function () {\r\n                    playing = true;\r\n                    log.debug('VIDEO_TIME play');\r\n                });\r\n                player.on('playing', function () {\r\n                    playing = true;\r\n                    log.debug('VIDEO_TIME playing');\r\n                });\r\n\r\n                player.on('pause', function () {\r\n                    playing = false;\r\n                    log.debug('VIDEO_TIME pause');\r\n                });\r\n                player.on('stalled', function () {\r\n                    playing = false;\r\n                    log.debug('VIDEO_TIME stalled');\r\n                });\r\n                player.on('suspend', function () {\r\n                    playing = false;\r\n                    log.debug('VIDEO_TIME suspend');\r\n                });\r\n                player.on('abort', function () {\r\n                    playing = false;\r\n                    log.debug('VIDEO_TIME abort');\r\n                });\r\n\r\n                player.on('ended', function () {\r\n                    playing = false;\r\n                    log.debug('VIDEO_TIME ended');\r\n\r\n                    // Ugly JavaScript chain.\r\n                    // First set the state.\r\n                    Ajax.call([{\r\n                        methodname: 'videotimeplugin_pro_set_session_state',\r\n                        args: {session_id: session.id, state: 1}\r\n                    }])[0].done(function() {\r\n\r\n                        // Then set the percentage.\r\n                        Ajax.call([{\r\n                            methodname: 'videotimeplugin_pro_set_percent',\r\n                            args: {session_id: session.id, percent: 1}\r\n                        }])[0].done(function() {\r\n\r\n                            // Then set the watch time to the end.\r\n                            Ajax.call([{\r\n                                methodname: 'videotimeplugin_pro_set_session_current_time',\r\n                                args: {session_id: session.id, current_time: currentTime}\r\n                            }])[0].done(function() {\r\n\r\n                                // Now that all data has been set on the session...\r\n                                if (nextActivityUrl) {\r\n                                    window.location.href = nextActivityUrl;\r\n                                } else {\r\n                                    Ajax.call([{\r\n                                        methodname: 'videotimeplugin_pro_get_next_activity_button_data',\r\n                                        args: {session_id: session.id}\r\n                                    }])[0].done(function(response) {\r\n                                        Templates.render('videotime/next_activity_button', JSON.parse(response.data))\r\n                                            .then(function(html, js) {\r\n                                                $('#next-activity-button').html(html);\r\n                                            });\r\n                                    });\r\n                                }\r\n                            });\r\n                        });\r\n                    });\r\n\r\n\r\n                });\r\n\r\n                player.on('timeupdate', function(event) {\r\n                    percent = event.percent;\r\n                    currentTime = event.seconds;\r\n                    log.debug('VIDEO_TIME timeupdate. Percent: ' + percent + '. Current time: ' + currentTime);\r\n                });\r\n\r\n                setInterval(function () {\r\n                    if (playing) {\r\n                        time++;\r\n\r\n                        if (time % interval === 0) {\r\n                            log.debug('VIDEO_TIME watch_time: ' + time + '. percent: ' + percent);\r\n                            Ajax.call([{\r\n                                methodname: 'videotimeplugin_pro_record_watch_time',\r\n                                args: {session_id: session.id, time: time}\r\n                            }]);\r\n                            Ajax.call([{\r\n                                methodname: 'videotimeplugin_pro_set_percent',\r\n                                args: {session_id: session.id, percent: percent}\r\n                            }]);\r\n                            Ajax.call([{\r\n                                methodname: 'videotimeplugin_pro_set_session_current_time',\r\n                                args: {session_id: session.id, current_time: currentTime}\r\n                            }]);\r\n                        }\r\n                    }\r\n                }, 1000);\r\n            }\r\n        }\r\n    };\r\n});\r\n"],"file":"videotime.min.js"}