{"version":3,"sources":["../src/videotime.js"],"names":["define","$","Vimeo","Ajax","log","Templates","initPlayer","session","interval","hasPro","embedOptions","cmid","resumeTime","nextActivityUrl","debug","player","playing","time","percent","currentTime","on","setCurrentTime","call","methodname","args","session_id","id","state","done","current_time","window","location","href","response","render","JSON","parse","data","then","html","event","seconds","setInterval","init","document","getElementById","i","console","clearInterval"],"mappings":"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","sourcesContent":["/*\n * @package    mod_videotime\n * @copyright  2018 bdecent gmbh <https://bdecent.de>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @module block_overview/helloworld\n */\ndefine(['jquery', 'mod_videotime/player', 'core/ajax', 'core/log', 'core/templates'], function($, Vimeo, Ajax, log, Templates) {\n\n    const initPlayer = function(session, interval, hasPro, embedOptions, cmid, resumeTime, nextActivityUrl) {\n\n        log.debug('VIDEO_TIME embed options', embedOptions);\n\n        const player = new Vimeo('vimeo-embed-' + cmid, embedOptions);\n\n        if (hasPro) {\n            let playing = false;\n            let time = 0;\n            let percent = 0;\n            let currentTime = 0;\n\n            if (resumeTime > 0) {\n                player.on('loaded', function() {\n                    player.setCurrentTime(resumeTime);\n                });\n            }\n\n            player.on('play', function () {\n                playing = true;\n                log.debug('VIDEO_TIME play');\n            });\n            player.on('playing', function () {\n                playing = true;\n                log.debug('VIDEO_TIME playing');\n            });\n\n            player.on('pause', function () {\n                playing = false;\n                log.debug('VIDEO_TIME pause');\n            });\n            player.on('stalled', function () {\n                playing = false;\n                log.debug('VIDEO_TIME stalled');\n            });\n            player.on('suspend', function () {\n                playing = false;\n                log.debug('VIDEO_TIME suspend');\n            });\n            player.on('abort', function () {\n                playing = false;\n                log.debug('VIDEO_TIME abort');\n            });\n\n            player.on('ended', function () {\n                playing = false;\n                log.debug('VIDEO_TIME ended');\n\n                // Ugly JavaScript chain.\n                // First set the state.\n                Ajax.call([{\n                    methodname: 'videotimeplugin_pro_set_session_state',\n                    args: {session_id: session.id, state: 1}\n                }])[0].done(function() {\n\n                    // Then set the percentage.\n                    Ajax.call([{\n                        methodname: 'videotimeplugin_pro_set_percent',\n                        args: {session_id: session.id, percent: 1}\n                    }])[0].done(function() {\n\n                        // Then set the watch time to the end.\n                        Ajax.call([{\n                            methodname: 'videotimeplugin_pro_set_session_current_time',\n                            args: {session_id: session.id, current_time: currentTime}\n                        }])[0].done(function() {\n\n                            // Now that all data has been set on the session...\n                            if (nextActivityUrl) {\n                                window.location.href = nextActivityUrl;\n                            } else {\n                                Ajax.call([{\n                                    methodname: 'videotimeplugin_pro_get_next_activity_button_data',\n                                    args: {session_id: session.id}\n                                }])[0].done(function(response) {\n                                    Templates.render('videotime/next_activity_button', JSON.parse(response.data))\n                                        .then(function(html, js) {\n                                            $('#next-activity-button').html(html);\n                                        });\n                                });\n                            }\n                        });\n                    });\n                });\n\n\n            });\n\n            player.on('timeupdate', function(event) {\n                percent = event.percent;\n                currentTime = event.seconds;\n                log.debug('VIDEO_TIME timeupdate. Percent: ' + percent + '. Current time: ' + currentTime);\n            });\n\n            setInterval(function () {\n                if (playing) {\n                    time++;\n\n                    if (time % interval === 0) {\n                        log.debug('VIDEO_TIME watch_time: ' + time + '. percent: ' + percent);\n                        Ajax.call([{\n                            methodname: 'videotimeplugin_pro_record_watch_time',\n                            args: {session_id: session.id, time: time}\n                        }]);\n                        Ajax.call([{\n                            methodname: 'videotimeplugin_pro_set_percent',\n                            args: {session_id: session.id, percent: percent}\n                        }]);\n                        Ajax.call([{\n                            methodname: 'videotimeplugin_pro_set_session_current_time',\n                            args: {session_id: session.id, current_time: currentTime}\n                        }]);\n                    }\n                }\n            }, 1000);\n        }\n    };\n\n    return {\n        init: function(session, interval, hasPro, embedOptions, cmid, resumeTime, nextActivityUrl) {\n\n            log.debug('VIDEO_TIME embed options', embedOptions);\n\n            if (!document.getElementById('vimeo-embed-' + cmid)) {\n                // Init player for Moodle mobile page.\n                const i = setInterval(function() {\n                    console.log(\"TICK\");\n                    if (document.getElementById('vimeo-embed-' + cmid)) {\n                        initPlayer(session, interval, hasPro, embedOptions, cmid, resumeTime, nextActivityUrl);\n                        clearInterval(i);\n                    }\n                }, 1000);\n            } else {\n                // Init player for web browser.\n                initPlayer(session, interval, hasPro, embedOptions, cmid, resumeTime, nextActivityUrl);\n            }\n        }\n    };\n});\n"],"file":"videotime.min.js"}