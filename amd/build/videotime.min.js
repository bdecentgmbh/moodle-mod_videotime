define ("mod_videotime/videotime",["jquery","mod_videotime/player","core/ajax","core/log","core/templates"],function(a,b,c,d,e){var f=function(a,b,c,d){this.elementId=a;this.cmId=b;this.hasPro=c;this.interval=d;this.player=null;this.resumeTime=null;this.session=null;this.played=!1;this.playing=!1;this.time=0;this.percent=0;this.currentTime=0};f.prototype.initialize=function(){d.debug("Initializing Video Time "+this.elementId);this.getEmbedOptions().then(function(a){d.debug("Initializing Vimeo player with options:");d.debug(a);this.player=new b(this.elementId,JSON.parse(a.options));this.addListeners()}.bind(this))};f.prototype.addListeners=function(){var b=this;if(!this.player){d.debug("Player was not properly initialized for course module ".this.cmId)}this.player.on("play",function(){if(!this.played){this.getSession().then(function(){this.view()}.bind(this))}}.bind(this));if(!this.hasPro){return}this.getResumeTime(this.cmId).then(function(a){d.debug("VIDEO_TIME resuming at "+a);if(a&&0<a){b.player.on("loaded",function(){b.player.setCurrentTime(a)})}});this.player.on("play",function(){this.playing=!0;d.debug("VIDEO_TIME play")}.bind(this));this.player.on("playing",function(){this.playing=!0;d.debug("VIDEO_TIME playing")}.bind(this));this.player.on("pause",function(){this.playing=!1;d.debug("VIDEO_TIME pause")}.bind(this));this.player.on("stalled",function(){this.playing=!1;d.debug("VIDEO_TIME stalled")}.bind(this));this.player.on("suspend",function(){this.playing=!1;d.debug("VIDEO_TIME suspend")}.bind(this));this.player.on("abort",function(){this.playing=!1;d.debug("VIDEO_TIME abort")}.bind(this));this.player.on("timeupdate",function(a){this.percent=a.percent;this.currentTime=a.seconds;d.debug("VIDEO_TIME timeupdate. Percent: "+this.percent+". Current time: "+this.currentTime)}.bind(this));this.player.on("ended",function(){this.playing=!1;d.debug("VIDEO_TIME ended");new Promise(function(a){this.getSession().then(function(b){a(b)})}.bind(this)).then(function(a){this.setSessionState(a.id,1);return a}.bind(this)).then(function(a){this.setPercent(a.id,1);return a}.bind(this)).then(function(a){this.setCurrentTime(a.id,this.currentTime);return a}.bind(this)).catch(function(a){alert(a)}).finally(function(){this.getSession().then(function(b){this.getNextActivityButtonData(b.id).then(function(b){var c=JSON.parse(b.data);if(c.instance.next_activity_auto){if(!c.is_restricted&&c.hasnextcm){window.location.href=c.nextcm_url}}e.render("videotime/next_activity_button",JSON.parse(b.data)).then(function(b){a("#next-activity-button").html(b)})}.bind(this))}.bind(this))}.bind(this))}.bind(this));this.startWatchInterval()};f.prototype.startWatchInterval=function(){setInterval(function(){if(this.playing){this.time++;this.getSession().then(function(a){if(0==this.time%this.interval){d.debug("VIDEO_TIME watch_time: "+this.time+". percent: "+this.percent);this.recordWatchTime(a.id,this.time);this.setPercent(a.id,this.percent);this.setCurrentTime(a.id,this.currentTime)}}.bind(this))}}.bind(this),1e3)};f.prototype.setSessionState=function(a,b){return c.call([{methodname:"videotimeplugin_pro_set_session_state",args:{session_id:a,state:b}}])[0]};f.prototype.setCurrentTime=function(a,b){return c.call([{methodname:"videotimeplugin_pro_set_session_current_time",args:{session_id:a,current_time:b}}])[0]};f.prototype.setPercent=function(a,b){return c.call([{methodname:"videotimeplugin_pro_set_percent",args:{session_id:a,percent:b}}])[0]};f.prototype.recordWatchTime=function(a,b){return c.call([{methodname:"videotimeplugin_pro_record_watch_time",args:{session_id:a,time:b}}])[0]};f.prototype.getNextActivityButtonData=function(a){return c.call([{methodname:"videotimeplugin_pro_get_next_activity_button_data",args:{session_id:a}}])[0]};f.prototype.getEmbedOptions=function(){return c.call([{methodname:"mod_videotime_get_embed_options",args:{cmid:this.cmId}}])[0]};f.prototype.getResumeTime=function(a){var b=this;if(this.resumeTime){return Promise.resolve(this.resumeTime)}return new Promise(function(d){c.call([{methodname:"videotimeplugin_pro_get_resume_time",args:{cmid:a}}])[0].then(function(a){this.resumeTime=a.seconds;d(this.resumeTime)}.bind(b))})};f.prototype.getSession=function(){var a=this;if(this.session){return Promise.resolve(this.session)}return new Promise(function(b){c.call([{methodname:"videotimeplugin_pro_get_new_session",args:{cmid:a.cmId}}])[0].then(function(a){this.session=a;b(a)}.bind(a))})};f.prototype.view=function(){return c.call([{methodname:"mod_videotime_view_videotime",args:{cmid:this.cmId}}])[0]};return f});
//# sourceMappingURL=videotime.min.js.map
