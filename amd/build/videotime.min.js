define ("mod_videotime/videotime",["jquery","mod_videotime/player","core/ajax","core/config","core/log","core/templates","core/notification"],function(a,b,c,d,e,f,g){var h=function(b,c,d,e,f){this.elementId=b;this.cmId=c;this.hasPro=d;this.interval=e;this.player=null;this.resumeTime=null;this.session=null;this.instance=f;this.played=!1;this.playing=!1;this.time=0;this.percent=0;this.currentTime=0;this.playbackRate=1;this.plugins=[];if(d&&a("body").hasClass("path-course-view")&&!a("body").hasClass("vtinit")){a("body").addClass("vtinit");a(document).on("focus","body",this.initializeNewInstances.bind(this))}this.modulecount=a("body .activity.videotime").length};h.prototype.getCmId=function(){return this.cmId};h.prototype.registerPlugin=function(a){this.plugins.push(a)};h.prototype.initialize=function(){var a=this.instance;e.debug("Initializing Video Time "+this.elementId);e.debug("Initializing Vimeo player with options:");e.debug(a);this.player=new b(this.elementId,{autopause:+a.autopause,autoplay:+a.autoplay,background:+a.background,byline:+a.byline,color:a.color,controls:+a.controls,dnt:+a.dnt,height:a.height,loop:+a.option_loop,maxheight:a.maxheight,maxwidth:a.maxwidth,muted:+a.muted,portrait:a.portrait,pip:+a.pip,playsinline:a.playsinline,responsive:+a.responsive,speed:a.speed,title:+a.title,transparent:+a.transparent,url:a.vimeo_url,width:a.width});var c=new URL(window.location.href),d=c.searchParams.get("q"),f=(c.searchParams.get("time")||"").match(/^([0-9]+:){0,2}([0-9]+)(\.[0-9]+)$/);if(f){this.setStartTime(f[0]).then(function(){if(d&&window.find){window.find(d)}return!0}).catch(g.exception)}else if(d&&window.find){window.find(d)}this.handleStartTime();this.addListeners();for(var h=0,i;h<this.plugins.length;h++){i=this.plugins[h];i.initialize(this,a)}return!0};h.prototype.handleStartTime=function(){var a=new URL(window.location.href),b=a.searchParams.get("q"),c=(a.searchParams.get("time")||"").match(/^([0-9]+:){0,2}([0-9]+)(\.[0-9]+)$/);if(b&&window.find){window.find(b)}if(c){return this.setStartTime(c[0])}return this.player.getCurrentTime()};h.prototype.getPaused=function(){return this.player.getPaused()};h.prototype.getPlayer=function(){return this.player};h.prototype.addListeners=function(){var b=this;if(!this.player){e.debug("Player was not properly initialized for course module "+this.cmId);return}a(a("#"+this.elementId).closest(".videotimetabs")).each(function(b,c){a(c).find("[data-action=\"cue\"]").each(function(a,b){var c=b.getAttribute("data-start"),d=c.match(/((([0-9]+):)?(([0-9]+):))?([0-9]+(\.[0-9]+))/);if(d){this.player.addCuePoint(3600*+(d[3]||0)+60*+(d[5]||0)+ +d[6],{starttime:c}).catch(g.exeception)}}.bind(this));this.player.on("cuepoint",function(b){if(b.data.starttime){a(c).find(".videotime-highlight").removeClass("videotime-highlight");a(c).find("[data-action=\"cue\"][data-start=\""+b.data.starttime+"\"]").closest(".row").addClass("videotime-highlight");a(".videotime-highlight").each(function(){if(this.offsetTop){this.parentNode.scrollTo({top:this.offsetTop-50,left:0,behavior:"smooth"})}})}})}.bind(this));this.player.on("play",function(){if(b.hasPro){b.startWatchInterval()}b.view();return!0});if(!this.hasPro){return}this.player.on("loaded",function(){if(!b.instance.resume_playback||!b.instance.resume_time||0>=b.instance.resume_time){return!0}return b.getDuration().then(function(a){var c=b.instance.resume_time;if(c+1>=Math.floor(a)){e.debug("VIDEO_TIME video finished, resuming at start of video.");c=0}e.debug("VIDEO_TIME duration is "+a);e.debug("VIDEO_TIME resuming at "+c);b.setCurrentPosition(c);return!0}).fail(g.exception)});this.player.on("play",function(){this.playing=!0;e.debug("VIDEO_TIME play")}.bind(this));this.player.on("playing",function(){this.playing=!0;e.debug("VIDEO_TIME playing")}.bind(this));this.player.on("pause",function(){this.playing=!1;e.debug("VIDEO_TIME pause")}.bind(this));this.player.on("stalled",function(){this.playing=!1;e.debug("VIDEO_TIME stalled")}.bind(this));this.player.on("suspend",function(){this.playing=!1;e.debug("VIDEO_TIME suspend")}.bind(this));this.player.on("abort",function(){this.playing=!1;e.debug("VIDEO_TIME abort")}.bind(this));this.player.getPlaybackRate().then(function(a){this.playbackRate=a}.bind(this)).catch(g.exception);this.player.on("playbackratechange",function(a){this.playbackRate=a.playbackRate}.bind(this));this.player.on("timeupdate",function(a){this.percent=a.percent;this.currentTime=a.seconds;if(a.seconds===a.duration){this.plugins.forEach(function(b){if("function"==typeof b.setCurrentTime){b.getSessions().then(function(c){b.setCurrentTime(c.id,a.seconds);return c}).catch(g.exception)}})}}.bind(this));this.player.on("ended",this.handleEnd.bind(this));this.player.on("pause",this.handlePause.bind(this))};h.prototype.handlePause=function(){this.plugins.forEach(function(a){if("function"==typeof a.handlePause){a.handlePause()}})};h.prototype.handleEnd=function(){this.playing=!1;e.debug("VIDEO_TIME ended");if(2<this.plugins.length){this.plugins.forEach(function(a){if("function"==typeof a.handleEnd){a.handleEnd()}})}else{this.getSession().then(function(b){var c=this;this.setSessionState(b.id,1).then(function(){return c.setPercent(b.id,1)}).then(function(){return c.setCurrentTime(b.id,c.currentTime)}).then(function(){return c.getNextActivityButtonData(b.id).then(function(b){var c=JSON.parse(b.data);if(c.instance&&parseInt(c.instance.next_activity_auto)){if(!c.is_restricted&&c.hasnextcm){var d=a(".aalink[href=\""+c.nextcm_url+"\"] img").first();if(a(".path-course-view").length&&d){d.click()}else{window.location.href=c.nextcm_url}}}return f.render("videotime/next_activity_button",JSON.parse(b.data)).then(function(b){a("#next-activity-button").html(b);return!0})})}).catch(g.exception)}.bind(this)).catch(g.exception)}};h.prototype.startWatchInterval=function(){var a=this;this.plugins.forEach(function(b){if("function"==typeof b.startWatchInterval){a.watchInterval=!0;b.startWatchInterval()}});if(this.watchInterval){return}this.watchInterval=setInterval(function(){var a=this;this.getPaused().then(function(b){if(!b){a.time+=a.playbackRate}})}.bind(this),1e3);this.watchInterval=setInterval(function(){var a=this;this.getSession().then(function(b){e.debug("VIDEO_TIME watch_time: "+a.time+". percent: "+a.percent);a.recordWatchTime(b.id,a.time);a.setPercent(b.id,a.percent);a.setCurrentTime(b.id,a.currentTime)}).catch(g.exception)}.bind(this),this.interval)};h.prototype.setSessionState=function(a,b){if(this.instance.token){var e=new URL(d.wwwroot+"/webservice/rest/server.php"),f=e.searchParams;f.set("wstoken",this.instance.token);f.set("moodlewsrestformat","json");f.set("wsfunction","videotimeplugin_pro_set_session_state");f.set("state",b);f.set("session_id",a);return fetch(e).then(function(a){if(!a.ok){g.exeption("Web service error")}return a.json()})}return c.call([{methodname:"videotimeplugin_pro_set_session_state",args:{session_id:a,state:b},fail:g.exception}])[0]};h.prototype.setCurrentTime=function(a,b){if(this.instance.token){var e=new URL(d.wwwroot+"/webservice/rest/server.php"),f=e.searchParams;f.set("wstoken",this.instance.token);f.set("moodlewsrestformat","json");f.set("wsfunction","videotimeplugin_pro_set_session_current_time");f.set("current_time",b);f.set("session_id",a);return fetch(e).then(function(a){if(!a.ok){g.exeption("Web service error")}return a.json()})}return c.call([{methodname:"videotimeplugin_pro_set_session_current_time",args:{session_id:a,current_time:b},fail:g.exception}])[0]};h.prototype.setPercent=function(a,b){if(this.instance.token){var e=new URL(d.wwwroot+"/webservice/rest/server.php"),f=e.searchParams;f.set("wstoken",this.instance.token);f.set("moodlewsrestformat","json");f.set("wsfunction","videotimeplugin_pro_set_percent");f.set("percent",b);f.set("session_id",a);return fetch(e).then(function(a){if(!a.ok){g.exeption("Web service error")}return a.json()})}return c.call([{methodname:"videotimeplugin_pro_set_percent",args:{session_id:a,percent:b},fail:g.exception}])[0]};h.prototype.recordWatchTime=function(a,b){if(this.instance.token){var e=new URL(d.wwwroot+"/webservice/rest/server.php"),f=e.searchParams;f.set("wstoken",this.instance.token);f.set("moodlewsrestformat","json");f.set("wsfunction","videotimeplugin_pro_record_watch_time");f.set("session_id",a);f.set("time",b);return fetch(e).then(function(a){if(!a.ok){g.exeption("Web service error")}return a.json()})}return c.call([{methodname:"videotimeplugin_pro_record_watch_time",args:{session_id:a,time:b},fail:g.exception}])[0]};h.prototype.getNextActivityButtonData=function(a){if(this.instance.token){return Promise.resolve({data:"{}"})}return c.call([{methodname:"videotimeplugin_pro_get_next_activity_button_data",args:{session_id:a}}])[0]};h.prototype.getInstance=function(){var a=this;if(this.instance){return Promise.resolve(this.instance)}return c.call([{methodname:"mod_videotime_get_videotime",args:{cmid:this.cmId},done:function done(b){a.instance=b;return a.instance},fail:g.exception}])[0]};h.prototype.getResumeTime=function(){var a=this;if(this.resumeTime){return Promise.resolve(this.resumeTime)}return c.call([{methodname:"videotimeplugin_pro_get_resume_time",args:{cmid:this.cmId},done:function done(b){a.resumeTime=b.seconds;return a.resumeTime},fail:g.exception}])[0]};h.prototype.getSession=function(){if(this.instance.token){if(!this.session){var a=new URL(d.wwwroot+"/webservice/rest/server.php"),b=a.searchParams;b.set("wstoken",this.instance.token);b.set("moodlewsrestformat","json");b.set("wsfunction","videotimeplugin_pro_get_new_session");b.set("cmid",this.cmId);this.session=fetch(a).then(function(a){if(!a.ok){g.exeption("Web service error")}return a.json()})}return this.session}if(!this.session){this.session=c.call([{methodname:"videotimeplugin_pro_get_new_session",args:{cmid:this.cmId},fail:g.exception}])[0]}return this.session};h.prototype.setStartTime=function(a){var b=a.match(/((([0-9]+):)?(([0-9]+):))?([0-9]+(\.[0-9]+))/);if(b){this.resumeTime=3600*+(b[3]||0)+60*+(b[5]||0)+ +b[6];this.currentTime(this.resumeTime)}return this.player.getCurrentTime()};h.prototype.view=function(){if(this.instance.token){var a=new URL(d.wwwroot+"/webservice/rest/server.php"),b=a.searchParams;b.set("wstoken",this.instance.token);b.set("moodlewsrestformat","json");b.set("wsfunction","mod_videotime_view_videotime");b.set("cmid",this.cmId);return fetch(a).then(function(a){if(!a.ok){g.exeption("Web service error")}return a.json()})}return c.call([{methodname:"mod_videotime_view_videotime",args:{cmid:this.cmId},fail:g.exception}])[0]};h.prototype.initializeNewInstances=function(){if(this.modulecount==a("body .activity.videotime").length){return}this.modulecount=a("body .activity.videotime").length;a("body .activity.videotime").each(function(b,c){if(!a(c).find(".instancename").length&&a(c).find(".vimeo-embed").length&&!a(c).find(".vimeo-embed iframe").length){var d={cmid:+a(c).attr("id").replace("module-",""),haspro:!0,interval:this.interval,uniqueid:a(c).find(".vimeo-embed").first().attr("id").replace("vimeo-embed-","")};f.render("mod_videotime/videotime_instance",{instance:d}).then(function(a,b){f.runTemplateJS(b);return!0}).fail(g.exception)}}.bind(this))};h.prototype.getPlaybackRate=function(){return this.player.getPlaybackRate()};h.prototype.getDuration=function(){return this.player.getDuration()};h.prototype.setCurrentPosition=function(a){return this.player.setCurrentTime(a)};h.prototype.getCurrentPosition=function(){return this.player.getCurrentTime()};return h});
//# sourceMappingURL=videotime.min.js.map
