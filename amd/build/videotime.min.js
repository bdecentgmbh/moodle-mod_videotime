define ("mod_videotime/videotime",["jquery","mod_videotime/player","core/ajax","core/log","core/templates","core/notification"],function(a,b,c,d,e,f){var g=function(b,c,d,e){this.elementId=b;this.cmId=c;this.hasPro=d;this.interval=e;this.player=null;this.resumeTime=null;this.session=null;this.instance=null;this.played=!1;this.playing=!1;this.time=0;this.percent=0;this.currentTime=0;this.playbackRate=1;this.plugins=[];if(d&&a("body").hasClass("path-course-view")&&!a("body").hasClass("vtinit")){a("body").addClass("vtinit");a(document).on("focus","body",this.initializeNewInstances.bind(this))}this.modulecount=a("body .activity.videotime").length};g.prototype.getCmId=function(){return this.cmId};g.prototype.registerPlugin=function(a){this.plugins.push(a)};g.prototype.initialize=function(){var a=this;d.debug("Initializing Video Time "+this.elementId);this.getInstance().then(function(c){d.debug("Initializing Vimeo player with options:");d.debug(c);a.player=new b(a.elementId,{autopause:c.autopause,autoplay:c.autoplay,background:c.background,byline:c.byline,color:c.color,controls:c.controls,dnt:c.dnt,height:c.height,maxheight:c.maxheight,maxwidth:c.maxwidth,muted:c.muted,portrait:c.portrait,pip:c.pip,playsinline:c.playsinline,responsive:c.responsive,speed:c.speed,title:c.title,transparent:c.transparent,url:c.vimeo_url,width:c.width});a.player=new b(a.elementId,c);var e=new URL(window.location.href),g=e.searchParams.get("q"),h=(e.searchParams.get("time")||"").match(/^([0-9]+:){0,2}([0-9]+)(\.[0-9]+)$/);if(h){a.setStartTime(h[0]).then(function(){if(g&&window.find){window.find(g)}return!0}).catch(f.exception)}else if(g&&window.find){window.find(g)}a.addListeners();for(var j=0,i;j<a.plugins.length;j++){i=a.plugins[j];i.initialize(a,c)}return!0}).catch(f.exeption)};g.prototype.getPlayer=function(){return this.player};g.prototype.addListeners=function(){var b=this;if(!this.player){d.debug("Player was not properly initialized for course module "+this.cmId);return}this.player.on("play",function(){if(!b.played){if(b.hasPro){b.getSession().then(function(){b.view();b.startWatchInterval();return!0}).catch(f.exception)}else{b.view()}}return!0});if(!this.hasPro){return}this.getResumeTime().then(function(a){if(0>=a){return!0}b.getPlayer().getDuration().then(function(c){var e=a;if(a+1>=Math.floor(c)){d.debug("VIDEO_TIME video finished, resuming at start of video.");e=0}d.debug("VIDEO_TIME resuming at "+e);b.player.on("loaded",function(){b.player.setCurrentTime(e)});return!0}).catch(f.exception);return!0}).catch(f.exception);this.player.on("play",function(){this.playing=!0;d.debug("VIDEO_TIME play")}.bind(this));this.player.on("playing",function(){this.playing=!0;d.debug("VIDEO_TIME playing")}.bind(this));this.player.on("pause",function(){this.playing=!1;d.debug("VIDEO_TIME pause")}.bind(this));this.player.on("stalled",function(){this.playing=!1;d.debug("VIDEO_TIME stalled")}.bind(this));this.player.on("suspend",function(){this.playing=!1;d.debug("VIDEO_TIME suspend")}.bind(this));this.player.on("abort",function(){this.playing=!1;d.debug("VIDEO_TIME abort")}.bind(this));this.player.getPlaybackRate().then(function(a){this.playbackRate=a}.bind(this)).catch(f.exception);this.player.on("playbackratechange",function(a){this.playbackRate=a.playbackRate}.bind(this));this.player.on("timeupdate",function(a){this.percent=a.percent;this.currentTime=a.seconds;d.debug("VIDEO_TIME timeupdate. Percent: "+this.percent+". Current time: "+this.currentTime)}.bind(this));this.player.on("ended",function(){this.playing=!1;d.debug("VIDEO_TIME ended");new Promise(function(a){this.getSession().then(function(b){a(b);return!0}).catch(f.exception)}.bind(this)).then(function(a){this.setSessionState(a.id,1);return a}.bind(this)).then(function(a){this.setPercent(a.id,1);return a}.bind(this)).then(function(a){this.setCurrentTime(a.id,this.currentTime);return a}.bind(this)).catch(f.exception).finally(function(){this.getSession().then(function(b){this.getNextActivityButtonData(b.id).then(function(b){var c=JSON.parse(b.data);if(c.instance&&parseInt(c.instance.next_activity_auto)){if(!c.is_restricted&&c.hasnextcm){var d=a(".aalink[href=\""+c.nextcm_url+"\"] img").first();if(a(".path-course-view").length&&d){d.click()}else{window.location.href=c.nextcm_url}}}e.render("videotime/next_activity_button",JSON.parse(b.data)).then(function(b){a("#next-activity-button").html(b);return!0}).fail(f.exception);return!0}).fail(f.exception)}.bind(this)).catch(f.exception)}.bind(this)).fail(f.exception)}.bind(this));a(a("#"+this.elementId).closest(".videotimetabs")).each(function(b,c){a(c).find("[data-action=\"cue\"]").each(function(a,b){var c=b.getAttribute("data-start"),d=c.match(/((([0-9]+):)?(([0-9]+):))?([0-9]+(\.[0-9]+))/);if(d){this.player.addCuePoint(3600*+(d[3]||0)+60*+(d[5]||0)+ +d[6],{starttime:c}).catch(f.exeception)}}.bind(this));this.player.on("cuepoint",function(b){if(b.data.starttime){a(c).find(".videotime-highlight").removeClass("videotime-highlight");a(c).find("[data-action=\"cue\"][data-start=\""+b.data.starttime+"\"]").closest(".row").addClass("videotime-highlight");a(".videotime-highlight").each(function(){if(this.offsetTop){this.parentNode.scrollTo({top:this.offsetTop-50,left:0,behavior:"smooth"})}})}})}.bind(this))};g.prototype.startWatchInterval=function(){if(this.watchInterval){return}this.watchInterval=setInterval(function(){if(this.playing){this.time+=this.playbackRate;this.getSession().then(function(a){if(0==this.time%this.interval){d.debug("VIDEO_TIME watch_time: "+this.time+". percent: "+this.percent);this.recordWatchTime(a.id,this.time);this.setPercent(a.id,this.percent);this.setCurrentTime(a.id,this.currentTime)}return!0}.bind(this)).catch(f.exception)}}.bind(this),1e3)};g.prototype.setSessionState=function(a,b){return c.call([{methodname:"videotimeplugin_pro_set_session_state",args:{session_id:a,state:b}}])[0]};g.prototype.setCurrentTime=function(a,b){return c.call([{methodname:"videotimeplugin_pro_set_session_current_time",args:{session_id:a,current_time:b}}])[0]};g.prototype.setPercent=function(a,b){return c.call([{methodname:"videotimeplugin_pro_set_percent",args:{session_id:a,percent:b}}])[0]};g.prototype.recordWatchTime=function(a,b){return c.call([{methodname:"videotimeplugin_pro_record_watch_time",args:{session_id:a,time:b}}])[0]};g.prototype.getNextActivityButtonData=function(a){return c.call([{methodname:"videotimeplugin_pro_get_next_activity_button_data",args:{session_id:a}}])[0]};g.prototype.getInstance=function(){var a=this;if(this.instance){return Promise.resolve(this.instance)}return new Promise(function(b){c.call([{methodname:"mod_videotime_get_videotime",args:{cmid:a.cmId}}])[0].then(function(c){a.instance=c;b(a.instance);return!0}).fail(f.exception)})};g.prototype.getResumeTime=function(){var a=this;if(this.resumeTime){return Promise.resolve(this.resumeTime)}return new Promise(function(b){c.call([{methodname:"videotimeplugin_pro_get_resume_time",args:{cmid:a.cmId}}])[0].then(function(c){a.resumeTime=c.seconds;b(a.resumeTime);return!0}).fail(f.exception)})};g.prototype.getSession=function(){var a=this;if(this.session){return Promise.resolve(this.session)}return new Promise(function(b){c.call([{methodname:"videotimeplugin_pro_get_new_session",args:{cmid:a.cmId}}])[0].then(function(a){this.session=a;b(a);return!0}.bind(a)).fail(f.exception)})};g.prototype.setStartTime=function(a){var b=a.match(/((([0-9]+):)?(([0-9]+):))?([0-9]+(\.[0-9]+))/);if(b){this.resumeTime=3600*+(b[3]||0)+60*+(b[5]||0)+ +b[6];return this.player.setCurrentTime(this.resumeTime)}return this.player.getCurrentTime()};g.prototype.view=function(){return c.call([{methodname:"mod_videotime_view_videotime",args:{cmid:this.cmId}}])[0]};g.prototype.initializeNewInstances=function(){if(this.modulecount==a("body .activity.videotime").length){return}this.modulecount=a("body .activity.videotime").length;a("body .activity.videotime").each(function(b,c){if(!a(c).find(".instancename").length&&a(c).find(".vimeo-embed").length&&!a(c).find(".vimeo-embed iframe").length){var d={cmid:+a(c).attr("id").replace("module-",""),haspro:!0,interval:this.interval,uniqueid:a(c).find(".vimeo-embed").first().attr("id").replace("vimeo-embed-","")};e.render("mod_videotime/videotime_instance",{instance:d}).then(function(a,b){e.runTemplateJS(b);return!0}).fail(f.exception)}}.bind(this))};return g});
//# sourceMappingURL=videotime.min.js.map
